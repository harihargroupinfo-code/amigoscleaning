<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<meta charset="UTF-8">
<title>Admin Dashboard | Amigos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#0f4c81,#1e90ff);
  color:#fff;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px;
  background:rgba(0,0,0,0.25);
}
header img{height:40px;}
#welcome{
  background:#ffffff;
  color:#0f4c81;
  padding:6px 14px;
  border-radius:20px;
  font-weight:bold;
}
.logout{
  background:#ff4d4d;
  border:none;
  padding:8px 14px;
  color:#fff;
  border-radius:6px;
  cursor:pointer;
}

.container{padding:20px;}
.section{margin-bottom:30px;}
.section h2{margin-bottom:10px;}

.search-box{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  margin-bottom:10px;
}

.export-btn{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  background:#28a745;
  color:#fff;
  cursor:pointer;
  margin-bottom:20px;
}

.card{
  background:#fff;
  color:#333;
  border-radius:10px;
  padding:15px;
  margin-bottom:12px;
}
.card strong{color:#0f4c81;}

.btn{
  padding:6px 10px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  margin-right:5px;
}
.approve{background:#28a745;color:#fff;}
.delete{background:#dc3545;color:#fff;}

small{color:#555;}

@media(max-width:600px){
  header{flex-direction:column;gap:10px;}
}
</style>
</head>

<body>

<header>
  <img src="images/logo.jpg" alt="Amigos Logo">
  <div id="welcome">Welcome Admin</div>
  <button class="logout" onclick="logout()">Logout</button>
</header>

<div class="container">

  <!-- SEARCH + EXPORT -->
  <input
    type="text"
    id="searchInput"
    class="search-box"
    placeholder="üîç Search by name or mobile"
    onkeyup="renderDashboard()"
  >

  <button class="export-btn" onclick="exportUsers()">üì§ Export Users to Excel</button>

  <!-- Pending Distributors -->
  <div class="section">
    <h2>‚è≥ Pending Distributor Approvals</h2>
    <div id="pendingList"></div>
  </div>

  <!-- Approved Distributors -->
  <div class="section">
    <h2>‚úÖ Approved Distributors</h2>
    <div id="approvedDistributors"></div>
  </div>

  <!-- Retailers -->
  <div class="section">
    <h2>üè™ Retailers</h2>
    <div id="retailerList"></div>
  </div>

</div>

<script>
// --- SECURITY ---
if (localStorage.getItem("role") !== "admin") {
  location.href = "login.html";
}

// --- LOAD USERS (PERSISTENT STORAGE) ---
let users = JSON.parse(localStorage.getItem("users")) || [];

// --- RENDER DASHBOARD WITH SEARCH ---
function renderDashboard() {
  const search = document.getElementById("searchInput").value.toLowerCase();

  const pending = document.getElementById("pendingList");
  const approved = document.getElementById("approvedDistributors");
  const retailers = document.getElementById("retailerList");

  pending.innerHTML = approved.innerHTML = retailers.innerHTML = "";

  users.forEach((u, i) => {
    const searchable = `${u.name} ${u.mobile}`.toLowerCase();
    if (!searchable.includes(search)) return;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <strong>${u.name}</strong><br>
      üìß ${u.email}<br>
      üì± ${u.mobile}
    `;

    if (u.role === "distributor" && !u.approved) {
      card.innerHTML += `
        <br><br>
        <button class="btn approve" onclick="approve(${i})">Approve</button>
        <button class="btn delete" onclick="removeUser(${i})">Delete</button>
      `;
      pending.appendChild(card);
    }
    else if (u.role === "distributor" && u.approved) {
      card.innerHTML += `<br><small>‚úÖ Approved Distributor</small>`;
      approved.appendChild(card);
    }
    else if (u.role === "retailer") {
      card.innerHTML += `<br><small>üè™ Retailer</small>`;
      retailers.appendChild(card);
    }
  });

  if (!pending.innerHTML) pending.innerHTML = "<p>No pending distributors</p>";
  if (!approved.innerHTML) approved.innerHTML = "<p>No approved distributors</p>";
  if (!retailers.innerHTML) retailers.innerHTML = "<p>No retailers</p>";
}

// --- APPROVE DISTRIBUTOR ---
function approve(index) {
  users[index].approved = true;
  localStorage.setItem("users", JSON.stringify(users));
  alert("Distributor approved successfully");
  renderDashboard();
}

// --- DELETE USER ---
function removeUser(index) {
  if (!confirm("Are you sure you want to delete this user permanently?")) return;
  users.splice(index, 1);
  localStorage.setItem("users", JSON.stringify(users));
  renderDashboard();
}

// --- EXPORT USERS TO EXCEL (CSV) ---
function exportUsers() {
  let csv = "Name,Email,Mobile,Role,Approved\n";
  users.forEach(u => {
    csv += `"${u.name}","${u.email}","${u.mobile}","${u.role}","${u.approved}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "amigos_users.csv";
  a.click();

  URL.revokeObjectURL(url);
}

// --- SAFE LOGOUT ---
function logout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("role");
  localStorage.removeItem("userName");
  localStorage.removeItem("userEmail");
  location.href = "login.html";
}

// INITIAL LOAD
renderDashboard();
</script>

</body>
</html>

